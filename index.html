<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام طباعة الباركود - شركة جولن تكس للغزل</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a252f, #2c3e50);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/5ea6a74f-8596-47b2-8ec9-1c38a8088f90.png') center/cover;
            opacity: 0.1;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .company-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #f39c12, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .company-name {
            font-size: 1.8rem;
            color: #f39c12;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            padding: 40px;
        }

        .form-section {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .form-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.5rem;
            border-bottom: 3px solid #f39c12;
            padding-bottom: 10px;
            position: relative;
        }

        .form-section h2::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .serial-display {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .scale-section {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .scale-display {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .scale-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .scale-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .scale-status.connected {
            background: rgba(255,255,255,0.2);
        }

        .scale-status.disconnected {
            background: rgba(255,0,0,0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #f39c12;
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
            outline: none;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .color-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-input {
            width: 50px !important;
            height: 40px !important;
            padding: 0 !important;
            border-radius: 8px;
            cursor: pointer;
        }

        .color-text {
            flex: 1;
        }

        .datetime-section {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .datetime-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .shift-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .shift-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #bdc3c7;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .shift-btn.active {
            background: #f39c12;
            border-color: #f39c12;
            color: white;
        }

        .shift-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .preview-section {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .barcode-preview {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 2px solid #f39c12;
        }

        .barcode-info {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: right;
            border: 1px solid #e9ecef;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            width: 100%;
        }

        .barcode-info h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-right: 4px solid #f39c12;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }

        .info-item:hover {
            transform: translateY(-2px);
        }

        .info-item strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .info-item span {
            color: #34495e;
            font-size: 1rem;
            font-weight: 500;
        }

        .color-display {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #ddd;
        }

        .print-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .search-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .search-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-controls input,
        .search-controls select {
            flex: 1;
            min-width: 180px;
        }

        .records-table {
            grid-column: 1 / -1;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            overflow-x: auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 1200px;
        }

        .table th,
        .table td {
            padding: 12px 8px;
            text-align: right;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        .table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            position: sticky;
            top: 0;
        }

        .table tr:hover {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
        }

        .action-buttons {
            display: flex;
            gap: 3px;
            justify-content: center;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 11px;
            min-width: auto;
        }

        .company-footer {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 0.9rem;
        }

        .daily-summary {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border: 2px solid #27ae60;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #27ae60;
        }

        .stat-label {
            color: #2c3e50;
            margin-top: 5px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }

            .search-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .shift-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .table {
                font-size: 0.75rem;
            }

            .table th,
            .table td {
                padding: 8px 4px;
            }

            .print-buttons {
                flex-direction: column;
            }

            .btn {
                font-size: 12px;
                padding: 10px 20px;
            }
        }

        .empty-state {
            color: #7f8c8d;
            font-size: 1.2rem;
            padding: 40px;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #bdc3c7;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-area,
            .print-area * {
                visibility: visible;
            }
            
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .label-print {
            width: 8cm;
            height: 5cm;
            border: 1px solid #000;
            padding: 0.3cm;
            font-family: Arial, sans-serif;
            background: white;
        }

        .label-header {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }

        .label-barcode {
            text-align: center;
            margin: 8px 0;
        }

        .label-info {
            font-size: 9px;
            line-height: 1.2;
        }

        .label-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .label-serial {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 8px;
            background: #f39c12;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .weight-auto-fill {
            background: rgba(39, 174, 96, 0.1);
            border-color: #27ae60 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="company-logo">
                    <i class="fas fa-industry" style="color: #f39c12; font-size: 2rem;"></i>
                </div>
                <div class="company-name">شركة جولن تكس للغزل</div>
                <h1><i class="fas fa-barcode"></i> نظام طباعة الباركود</h1>
                <p>إدارة شاملة للإنتاج والباركود مع ربط الميزان</p>
            </div>
        </div>

        <div class="main-content">
            <!-- قسم الإدخال -->
            <div class="form-section">
                <h2><i class="fas fa-plus-circle"></i> إدخال بيانات الإنتاج</h2>
                
                <!-- عرض الرقم التسلسلي -->
                <div class="serial-display">
                    <i class="fas fa-hashtag"></i> الرقم التسلسلي: <span id="currentSerial">GT-0001</span>
                </div>

                <!-- قسم الميزان -->
                <div class="scale-section">
                    <h3><i class="fas fa-weight-hanging"></i> الميزان الإلكتروني</h3>
                    <div class="scale-display" id="scaleDisplay">0.00 كجم</div>
                    <div class="scale-status disconnected" id="scaleStatus">غير متصل</div>
                    <div class="scale-controls">
                        <button class="btn btn-success btn-sm" onclick="connectScale()">
                            <i class="fas fa-link"></i> اتصال
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="tareScale()">
                            <i class="fas fa-balance-scale"></i> صفر الميزان
                        </button>
                        <button class="btn btn-info btn-sm" onclick="readWeight()">
                            <i class="fas fa-sync-alt"></i> قراءة الوزن
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="useScaleWeight()">
                            <i class="fas fa-download"></i> استخدم الوزن
                        </button>
                    </div>
                </div>
                
                <div class="datetime-section">
                    <h3><i class="fas fa-calendar-alt"></i> معلومات الإنتاج</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> تاريخ الإنتاج:</label>
                            <input type="date" id="productionDate" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-cog"></i> رقم المكنة:</label>
                            <input type="text" id="machineNumber" placeholder="رقم المكنة" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> الوردية:</label>
                        <div class="shift-buttons">
                            <div class="shift-btn" data-shift="صباحية" onclick="selectShift(this)">
                                <i class="fas fa-sun"></i> صباحية
                            </div>
                            <div class="shift-btn" data-shift="مسائية" onclick="selectShift(this)">
                                <i class="fas fa-moon"></i> مسائية
                            </div>
                            <div class="shift-btn" data-shift="ليلية" onclick="selectShift(this)">
                                <i class="fas fa-star"></i> ليلية
                            </div>
                        </div>
                        <input type="hidden" id="workShift" required>
                    </div>
                </div>

                <form id="barcodeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-envelope"></i> رقم الرسالة:</label>
                            <input type="text" id="messageNumber" placeholder="رقم الرسالة" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-barcode"></i> محتوى الباركود:</label>
                            <input type="text" id="barcodeContent" required>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label><i class="fas fa-align-left"></i> الوصف:</label>
                        <textarea id="description" placeholder="وصف المنتج أو ملاحظات مهمة..." required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-flask"></i> الخليط:</label>
                            <select id="mixtureType" required>
                                <option value="">اختر النوع</option>
                                <option value="قطن 100%">قطن 100%</option>
                                <option value="بوليستر 100%">بوليستر 100%</option>
                                <option value="قطن/بوليستر 50/50">قطن/بوليستر 50/50</option>
                                <option value="قطن/بوليستر 65/35">قطن/بوليستر 65/35</option>
                                <option value="قطن/بوليستر 80/20">قطن/بوليستر 80/20</option>
                                <option value="كتان">كتان</option>
                                <option value="حرير">حرير</option>
                                <option value="فيسكوز">فيسكوز</option>
                                <option value="أكريليك">أكريليك</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-project-diagram"></i> نوع الخيط:</label>
                            <select id="threadType" required>
                                <option value="">اختر النوع</option>
                                <option value="سادة">سادة</option>
                                <option value="مبروم">مبروم</option>
                                <option value="مضفر">مضفر</option>
                                <option value="كومباكت">كومباكت</option>
                                <option value="مفتوح النهاية">مفتوح النهاية</option>
                                <option value="حلقي">حلقي</option>
                                <option value="نصف مفتول">نصف مفتول</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-sort-numeric-up"></i> عدد المبين:</label>
                            <input type="number" id="spindleCount" min="1" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-palette"></i> لون المبين:</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="spindleColor" class="color-input" value="#ffffff">
                                <input type="text" id="spindleColorName" class="color-text" placeholder="اسم اللون" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label><i class="fas fa-weight"></i> الوزن القائم (كجم):</label>
                            <input type="number" id="totalWeight" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-balance-scale"></i> الوزن الصافي (كجم):</label>
                            <input type="number" id="netWeight" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-box"></i> وزن الصندوق (كجم):</label>
                            <input type="number" id="boxWeight" step="0.01" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-id-card"></i> رقم عامل الباركود:</label>
                        <input type="text" id="workerNumber" required>
                    </div>

                    <div style="text-align: center; margin-top: 25px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> إنشاء الباركود
                        </button>
                        <button type="button" class="btn btn-warning" onclick="clearForm()">
                            <i class="fas fa-eraser"></i> مسح البيانات
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetSerial()">
                            <i class="fas fa-redo"></i> إعادة تعيين الرقم التسلسلي
                        </button>
                    </div>
                </form>
            </div>

            <!-- قسم المعاينة -->
            <div class="preview-section" id="previewSection">
                <div class="empty-state">
                    <i class="fas fa-barcode"></i>
                    <div>قم بملء البيانات لمعاينة الباركود</div>
                </div>
            </div>

            <!-- الملخص اليومي -->
            <div class="daily-summary" id="dailySummary" style="display: none;">
                <h3><i class="fas fa-chart-line"></i> ملخص الإنتاج اليومي</h3>
                <div class="summary-stats" id="summaryStats">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
                <button class="btn btn-success" onclick="downloadDailyPDF()">
                    <i class="fas fa-file-pdf"></i> تحميل تقرير يومي PDF
                </button>
            </div>

            <!-- قسم البحث والتصفية -->
            <div class="search-section">
                <h3><i class="fas fa-search"></i> البحث والتصفية</h3>
                <div class="search-controls">
                    <input type="text" id="searchInput" placeholder="البحث في جميع الحقول...">
                    <select id="filterMachine">
                        <option value="">جميع المكن</option>
                    </select>
                    <select id="filterMixture">
                        <option value="">جميع الخلائط</option>
                        <option value="قطن 100%">قطن 100%</option>
                        <option value="بوليستر 100%">بوليستر 100%</option>
                        <option value="قطن/بوليستر 50/50">قطن/بوليستر 50/50</option>
                        <option value="قطن/بوليستر 65/35">قطن/بوليستر 65/35</option>
                        <option value="قطن/بوليستر 80/20">قطن/بوليستر 80/20</option>
                        <option value="كتان">كتان</option>
                        <option value="حرير">حرير</option>
                        <option value="فيسكوز">فيسكوز</option>
                        <option value="أكريليك">أكريليك</option>
                    </select>
                    <select id="filterShift">
                        <option value="">جميع الورديات</option>
                        <option value="صباحية">صباحية</option>
                        <option value="مسائية">مسائية</option>
                        <option value="ليلية">ليلية</option>
                    </select>
                    <input type="date" id="filterDate" placeholder="تاريخ محدد">
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i> تصدير CSV
                    </button>
                </div>
            </div>

            <!-- جدول السجلات -->
            <div class="records-table">
                <table class="table" id="recordsTable">
                    <thead>
                        <tr>
                            <th>الرقم التسلسلي</th>
                            <th>الباركود</th>
                            <th>رقم المكنة</th>
                            <th>رقم الرسالة</th>
                            <th>الوصف</th>
                            <th>تاريخ الإنتاج</th>
                            <th>الوردية</th>
                            <th>الخليط</th>
                            <th>نوع الخيط</th>
                            <th>عدد المبين</th>
                            <th>لون المبين</th>
                            <th>الوزن القائم</th>
                            <th>الوزن الصافي</th>
                            <th>وزن الصندوق</th>
                            <th>رقم العامل</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <tr>
                            <td colspan="16" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <div>لا توجد سجلات بعد</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="company-footer">
            <p>© 2024 شركة جولن تكس للغزل - جميع الحقوق محفوظة</p>
        </div>
    </div>

    <!-- منطقة الطباعة المخفية -->
    <div class="print-area" id="printArea" style="display: none;"></div>

    <script>
        let records = JSON.parse(localStorage.getItem('goldenTexBarcodeRecords')) || [];
        let currentRecord = null;
        let serialNumber = parseInt(localStorage.getItem('goldenTexSerialNumber')) || 1;
        let scaleConnected = false;
        let currentWeight = 0;
        let scalePort = null;

        // تحديث عرض الرقم التسلسلي
        function updateSerialDisplay() {
            document.getElementById('currentSerial').textContent = `GT-${String(serialNumber).padStart(4, '0')}`;
        }

        // إعادة تعيين الرقم التسلسلي
        function resetSerial() {
            if (confirm('هل أنت متأكد من إعادة تعيين الرقم التسلسلي إلى 1؟')) {
                serialNumber = 1;
                localStorage.setItem('goldenTexSerialNumber', serialNumber);
                updateSerialDisplay();
                showNotification('تم إعادة تعيين الرقم التسلسلي!', 'success');
            }
        }

        // ربط الميزان
        async function connectScale() {
            try {
                if ('serial' in navigator) {
                    scalePort = await navigator.serial.requestPort();
                    await scalePort.open({ baudRate: 9600 });
                    
                    scaleConnected = true;
                    updateScaleStatus();
                    showNotification('تم الاتصال بالميزان بنجاح!', 'success');
                    
                    // بدء قراءة البيانات المستمرة
                    startScaleReading();
                } else {
                    // محاكاة للمتصفحات التي لا تدعم Web Serial API
                    simulateScaleConnection();
                }
            } catch (error) {
                showNotification('فشل في الاتصال بالميزان!', 'error');
                console.error('Scale connection error:', error);
            }
        }

        // محاكاة اتصال الميزان
        function simulateScaleConnection() {
            scaleConnected = true;
            updateScaleStatus();
            showNotification('تم الاتصال بالميزان (محاكاة)!', 'success');
            
            // محاكاة قراءة الوزن
            setInterval(() => {
                if (scaleConnected) {
                    // محاكاة وزن متغير
                    currentWeight = (Math.random() * 50 + 10).toFixed(2);
                    updateScaleDisplay();
                }
            }, 2000);
        }

        // قراءة البيانات من الميزان
        async function startScaleReading() {
            if (!scalePort) return;
            
            const reader = scalePort.readable.getReader();
            
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // تحليل البيانات الواردة من الميزان
                    const data = new TextDecoder().decode(value);
                    parseScaleData(data);
                }
            } catch (error) {
                console.error('Scale reading error:', error);
            } finally {
                reader.releaseLock();
            }
        }

        // تحليل بيانات الميزان
        function parseScaleData(data) {
            // تحليل البيانات حسب بروتوكول الميزان المستخدم
            const weightMatch = data.match(/(\d+\.?\d*)/);
            if (weightMatch) {
                currentWeight = parseFloat(weightMatch[1]);
                updateScaleDisplay();
            }
        }

        // تحديث عرض الميزان
        function updateScaleDisplay() {
            document.getElementById('scaleDisplay').textContent = `${currentWeight} كجم`;
        }

        // تحديث حالة الميزان
        function updateScaleStatus() {
            const statusElement = document.getElementById('scaleStatus');
            if (scaleConnected) {
                statusElement.textContent = 'متصل';
                statusElement.className = 'scale-status connected';
            } else {
                statusElement.textContent = 'غير متصل';
                statusElement.className = 'scale-status disconnected';
            }
        }

        // صفر الميزان
        async function tareScale() {
            if (scaleConnected && scalePort) {
                try {
                    const writer = scalePort.writable.getWriter();
                    await writer.write(new TextEncoder().encode('T\r\n')); // أمر الصفر
                    writer.releaseLock();
                    showNotification('تم تصفير الميزان!', 'success');
                } catch (error) {
                    console.error('Tare error:', error);
                }
            } else {
                // محاكاة
                currentWeight = 0;
                updateScaleDisplay();
                showNotification('تم تصفير الميزان (محاكاة)!', 'success');
            }
        }

        // قراءة الوزن
        function readWeight() {
            if (scaleConnected) {
                // في الميزان الحقيقي، سيتم قراءة الوزن تلقائياً
                // هنا فقط محاكاة
                if (!scalePort) {
                    currentWeight = (Math.random() * 50 + 10).toFixed(2);
                    updateScaleDisplay();
                }
                showNotification(`تم قراءة الوزن: ${currentWeight} كجم`, 'success');
            } else {
                showNotification('الميزان غير متصل!', 'error');
            }
        }

        // استخدام وزن الميزان
        function useScaleWeight() {
            if (scaleConnected && currentWeight > 0) {
                document.getElementById('totalWeight').value = currentWeight;
                document.getElementById('totalWeight').classList.add('weight-auto-fill');
                
                // حساب وزن الصندوق افتراضياً (1.5 كجم)
                const boxWeight = 1.5;
                const netWeight = (currentWeight - boxWeight).toFixed(2);
                
                document.getElementById('netWeight').value = netWeight;
                document.getElementById('boxWeight').value = boxWeight;
                
                document.getElementById('netWeight').classList.add('weight-auto-fill');
                document.getElementById('boxWeight').classList.add('weight-auto-fill');
                
                showNotification(`تم استخدام الوزن: ${currentWeight} كجم`, 'success');
                updateLivePreview();
            } else {
                showNotification('لا يوجد وزن صالح للاستخدام!', 'error');
            }
        }

        // تعيين التاريخ الحالي افتراضياً
        document.getElementById('productionDate').value = new Date().toISOString().split('T')[0];

        // تحديث عرض الرقم التسلسلي عند التحميل
        updateSerialDisplay();

        // تحديث لون المبين عند تغييره
        document.getElementById('spindleColor').addEventListener('change', function() {
            const colorName = getColorName(this.value);
            document.getElementById('spindleColorName').value = colorName;
            updateLivePreview();
        });

        // وظيفة للحصول على اسم اللون
        function getColorName(hex) {
            const colors = {
                '#ffffff': 'أبيض',
                '#000000': 'أسود',
                '#ff0000': 'أحمر',
                '#00ff00': 'أخضر',
                '#0000ff': 'أزرق',
                '#ffff00': 'أصفر',
                '#ff00ff': 'بنفسجي',
                '#00ffff': 'سماوي',
                '#ffa500': 'برتقالي',
                '#800080': 'بنفسجي غامق',
                '#008000': 'أخضر غامق',
                '#800000': 'أحمر غامق',
                '#808080': 'رمادي',
                '#ffc0cb': 'وردي',
                '#a52a2a': 'بني'
            };
            return colors[hex] || hex;
        }

        // اختيار الوردية
        function selectShift(element) {
            document.querySelectorAll('.shift-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            document.getElementById('workShift').value = element.dataset.shift;
            updateLivePreview();
        }

        // إنشاء الباركود
        document.getElementById('barcodeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productionDate = document.getElementById('productionDate').value;
            const workShift = document.getElementById('workShift').value;
            
            if (!workShift) {
                showNotification('يرجى اختيار الوردية!', 'warning');
                return;
            }
            
            const totalWeight = parseFloat(document.getElementById('totalWeight').value);
            const netWeight = parseFloat(document.getElementById('netWeight').value);
            const boxWeight = parseFloat(document.getElementById('boxWeight').value);
            
            // التحقق من صحة الأوزان
            if (totalWeight <= netWeight) {
                showNotification('الوزن القائم يجب أن يكون أكبر من الوزن الصافي!', 'warning');
                return;
            }

            const currentSerial = `GT-${String(serialNumber).padStart(4, '0')}`;
            
            const formData = {
                serialNumber: currentSerial,
                machineNumber: document.getElementById('machineNumber').value,
                messageNumber: document.getElementById('messageNumber').value,
                barcodeContent: document.getElementById('barcodeContent').value,
                description: document.getElementById('description').value,
                productionDate: productionDate,
                workShift: workShift,
                mixtureType: document.getElementById('mixtureType').value,
                threadType: document.getElementById('threadType').value,
                spindleCount: parseInt(document.getElementById('spindleCount').value),
                spindleColor: document.getElementById('spindleColor').value,
                spindleColorName: document.getElementById('spindleColorName').value,
                totalWeight: totalWeight,
                netWeight: netWeight,
                boxWeight: boxWeight,
                workerNumber: document.getElementById('workerNumber').value,
                createdDate: new Date().toLocaleDateString('ar-EG'),
                createdTime: new Date().toLocaleTimeString('ar-EG'),
                id: Date.now()
            };

            records.push(formData);
            localStorage.setItem('goldenTexBarcodeRecords', JSON.stringify(records));
            
            // زيادة الرقم التسلسلي
            serialNumber++;
            localStorage.setItem('goldenTexSerialNumber', serialNumber);
            updateSerialDisplay();
            
            showPreview(formData);
            updateTable();
            updateMachineFilter();
            updateDailySummary();
            
            showNotification('تم إنشاء الباركود بنجاح!', 'success');
        });

        function showPreview(data) {
            currentRecord = data;
            const previewSection = document.getElementById('previewSection');
            
            previewSection.innerHTML = `
                <div class="barcode-preview">
                    <svg id="barcode"></svg>
                </div>
                <div class="barcode-info fade-in">
                    <h3><i class="fas fa-info-circle"></i> معلومات الباركود - ${data.serialNumber}</h3>
                    <div class="info-grid">
                        <div class="info-item" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border-right-color: #2980b9;">
                            <strong style="color: white;"><i class="fas fa-hashtag"></i> الرقم التسلسلي:</strong>
                            <span style="color: white; font-size: 1.2rem; font-weight: bold;">${data.serialNumber}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-cog"></i> رقم المكنة:</strong>
                            <span>${data.machineNumber}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-envelope"></i> رقم الرسالة:</strong>
                            <span>${data.messageNumber}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-calendar"></i> تاريخ الإنتاج:</strong>
                            <span>${data.productionDate}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-clock"></i> الوردية:</strong>
                            <span>${data.workShift}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-flask"></i> الخليط:</strong>
                            <span>${data.mixtureType}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-project-diagram"></i> نوع الخيط:</strong>
                            <span>${data.threadType}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-sort-numeric-up"></i> عدد المبين:</strong>
                            <span>${data.spindleCount}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-palette"></i> لون المبين:</strong>
                            <span class="color-display">
                                <span class="color-box" style="background-color: ${data.spindleColor}"></span>
                                ${data.spindleColorName}
                            </span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-weight"></i> الوزن القائم:</strong>
                            <span>${data.totalWeight} كجم</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-balance-scale"></i> الوزن الصافي:</strong>
                            <span>${data.netWeight} كجم</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-box"></i> وزن الصندوق:</strong>
                            <span>${data.boxWeight} كجم</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-id-card"></i> رقم العامل:</strong>
                            <span>${data.workerNumber}</span>
                        </div>
                    </div>
                    <div class="info-item" style="grid-column: 1 / -1; margin-top: 15px;">
                        <strong><i class="fas fa-align-left"></i> الوصف:</strong><br>
                        <span style="white-space: pre-wrap;">${data.description}</span>
                    </div>
                </div>
                <div class="print-buttons">
                    <button class="btn btn-success" onclick="printBarcodeNormal()">
                        <i class="fas fa-print"></i> طباعة عادية
                    </button>
                    <button class="btn btn-info" onclick="printBarcodeSmall()">
                        <i class="fas fa-compress-alt"></i> طباعة صغيرة
                    </button>
                    <button class="btn btn-secondary" onclick="printLabel()">
                        <i class="fas fa-tag"></i> طباعة ملصق
                    </button>
                    <button class="btn btn-warning" onclick="downloadBarcodePDF()">
                        <i class="fas fa-file-pdf"></i> تحميل PDF
                    </button>
                </div>
            `;

            // إنشاء الباركود القابل للمسح
            JsBarcode("#barcode", data.barcodeContent, {
                format: "CODE128",
                width: 3,
                height: 100,
                displayValue: true,
                fontSize: 18,
                textMargin: 10,
                background: "#ffffff",
                lineColor: "#000000"
            });
        }

        // إنشاء بيانات معاينة من الفورم دون حفظ
        function getFormPreviewData() {
            const currentSerialStr = `GT-${String(serialNumber).padStart(4, '0')}`;
            const barcodeContent = document.getElementById('barcodeContent').value.trim();
            if (!barcodeContent) return null; // نحتاج على الأقل محتوى الباركود

            const productionDate = document.getElementById('productionDate').value || new Date().toISOString().split('T')[0];
            const workShift = document.getElementById('workShift').value || '';
            const totalWeight = parseFloat(document.getElementById('totalWeight').value) || 0;
            const netWeight = parseFloat(document.getElementById('netWeight').value) || 0;
            const boxWeight = parseFloat(document.getElementById('boxWeight').value) || 0;

            return {
                serialNumber: currentSerialStr,
                machineNumber: document.getElementById('machineNumber').value || '',
                messageNumber: document.getElementById('messageNumber').value || '',
                barcodeContent: barcodeContent,
                description: document.getElementById('description').value || '',
                productionDate: productionDate,
                workShift: workShift || '—',
                mixtureType: document.getElementById('mixtureType').value || '',
                threadType: document.getElementById('threadType').value || '',
                spindleCount: parseInt(document.getElementById('spindleCount').value) || 0,
                spindleColor: document.getElementById('spindleColor').value || '#ffffff',
                spindleColorName: document.getElementById('spindleColorName').value || getColorName(document.getElementById('spindleColor').value || '#ffffff'),
                totalWeight: totalWeight,
                netWeight: netWeight,
                boxWeight: boxWeight,
                workerNumber: document.getElementById('workerNumber').value || '',
                createdDate: new Date().toLocaleDateString('ar-EG'),
                createdTime: new Date().toLocaleTimeString('ar-EG'),
                id: Date.now()
            };
        }

        // تحديث المعاينة الحية دون حفظ
        function updateLivePreview() {
            const data = getFormPreviewData();
            const previewSection = document.getElementById('previewSection');
            if (data) {
                showPreview(data);
            } else {
                previewSection.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-barcode"></i>
                        <div>قم بملء البيانات لمعاينة الباركود</div>
                    </div>
                `;
                currentRecord = null;
            }
        }

        function updateTable() {
            const tbody = document.getElementById('recordsBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterMachine = document.getElementById('filterMachine').value;
            const filterMixture = document.getElementById('filterMixture').value;
            const filterShift = document.getElementById('filterShift').value;
            const filterDate = document.getElementById('filterDate').value;

            let filteredRecords = records.filter(record => {
                const matchesSearch = Object.values(record).some(value => 
                    value.toString().toLowerCase().includes(searchTerm)
                );
                const matchesMachine = !filterMachine || record.machineNumber === filterMachine;
                const matchesMixture = !filterMixture || record.mixtureType === filterMixture;
                const matchesShift = !filterShift || record.workShift === filterShift;
                const matchesDate = !filterDate || record.productionDate === filterDate;
                
                return matchesSearch && matchesMachine && matchesMixture && matchesShift && matchesDate;
            });

            filteredRecords.sort((a, b) => b.id - a.id);

            if (filteredRecords.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="16" class="empty-state">
                            <i class="fas fa-search"></i>
                            <div>لا توجد نتائج مطابقة للبحث</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredRecords.map(record => `
                <tr class="fade-in">
                    <td style="font-weight: bold; color: #3498db;">${record.serialNumber}</td>
                    <td>${record.barcodeContent}</td>
                    <td>${record.machineNumber}</td>
                    <td>${record.messageNumber}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${record.description}">${record.description.substring(0, 30)}${record.description.length > 30 ? '...' : ''}</td>
                    <td>${record.productionDate}</td>
                    <td>
                        <span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem;">
                            ${record.workShift}
                        </span>
                    </td>
                    <td>${record.mixtureType}</td>
                    <td>${record.threadType}</td>
                    <td>${record.spindleCount}</td>
                    <td>
                        <span class="color-display">
                            <span class="color-box" style="background-color: ${record.spindleColor}"></span>
                            ${record.spindleColorName}
                        </span>
                    </td>
                    <td>${record.totalWeight}</td>
                    <td>${record.netWeight}</td>
                    <td>${record.boxWeight}</td>
                    <td>${record.workerNumber}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="viewRecord(${record.id})" title="عرض">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-success btn-sm" onclick="printRecord(${record.id})" title="طباعة">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="printLabelRecord(${record.id})" title="طباعة ملصق">
                                <i class="fas fa-tag"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord(${record.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateMachineFilter() {
            const filterMachine = document.getElementById('filterMachine');
            const machines = [...new Set(records.map(record => record.machineNumber))].sort();
            
            filterMachine.innerHTML = '<option value="">جميع المكن</option>';
            machines.forEach(machine => {
                filterMachine.innerHTML += `<option value="${machine}">${machine}</option>`;
            });
        }

        function updateDailySummary() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = records.filter(record => record.productionDate === today);
            
            if (todayRecords.length === 0) {
                document.getElementById('dailySummary').style.display = 'none';
                return;
            }

            document.getElementById('dailySummary').style.display = 'block';
            
            const totalRecords = todayRecords.length;
            const totalSpindles = todayRecords.reduce((sum, record) => sum + record.spindleCount, 0);
            const totalNetWeight = todayRecords.reduce((sum, record) => sum + record.netWeight, 0);
            const totalBoxWeight = todayRecords.reduce((sum, record) => sum + record.boxWeight, 0);
            const uniqueMachines = new Set(todayRecords.map(record => record.machineNumber)).size;

            document.getElementById('summaryStats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${totalRecords}</div>
                    <div class="stat-label">إجمالي السجلات</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${uniqueMachines}</div>
                    <div class="stat-label">عدد المكن</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${totalSpindles}</div>
                    <div class="stat-label">إجمالي المبين</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${totalNetWeight.toFixed(2)}</div>
                    <div class="stat-label">إجمالي الوزن الصافي (كجم)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${totalBoxWeight.toFixed(2)}</div>
                    <div class="stat-label">إجمالي وزن الصناديق (كجم)</div>
                </div>
            `;
        }

        function viewRecord(id) {
            const record = records.find(r => r.id === id);
            if (record) {
                showPreview(record);
                document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function printRecord(id) {
            const record = records.find(r => r.id === id);
            if (record) {
                currentRecord = record;
                printBarcodeNormal();
            }
        }

        function printLabelRecord(id) {
            const record = records.find(r => r.id === id);
            if (record) {
                currentRecord = record;
                printLabel();
            }
        }

        function deleteRecord(id) {
            if (confirm('هل أنت متأكد من حذف هذا السجل؟')) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('goldenTexBarcodeRecords', JSON.stringify(records));
                updateTable();
                updateMachineFilter();
                updateDailySummary();
                showNotification('تم حذف السجل بنجاح!', 'success');
            }
        }

        function printBarcodeNormal() {
            if (!currentRecord) return;
            createPrintArea(false);
        }

        function printBarcodeSmall() {
            if (!currentRecord) return;
            createPrintArea(true);
        }

        function printLabel() {
            if (!currentRecord) return;
            
            const printArea = document.getElementById('printArea');
            
            printArea.innerHTML = `
                <div class="label-print">
                    <div class="label-serial">${currentRecord.serialNumber}</div>
                    <div class="label-header">شركة جولن تكس للغزل</div>
                    <div class="label-barcode">
                        <svg id="labelBarcode" style="width: 100%;"></svg>
                    </div>
                    <div class="label-info">
                        <div class="label-info-row">
                            <span><strong>مكنة:</strong> ${currentRecord.machineNumber}</span>
                            <span><strong>رسالة:</strong> ${currentRecord.messageNumber}</span>
                        </div>
                        <div class="label-info-row">
                            <span><strong>التاريخ:</strong> ${currentRecord.productionDate}</span>
                            <span><strong>الوردية:</strong> ${currentRecord.workShift}</span>
                        </div>
                        <div class="label-info-row">
                            <span><strong>الخليط:</strong> ${currentRecord.mixtureType.substring(0, 20)}</span>
                        </div>
                        <div class="label-info-row">
                            <span><strong>المبين:</strong> ${currentRecord.spindleCount}</span>
                            <span><strong>لون:</strong> ${currentRecord.spindleColorName}</span>
                        </div>
                        <div class="label-info-row">
                            <span><strong>وزن صافي:</strong> ${currentRecord.netWeight} كجم</span>
                            <span><strong>وزن صندوق:</strong> ${currentRecord.boxWeight} كجم</span>
                        </div>
                        <div style="margin-top: 3px; font-size: 8px;">
                            <strong>الوصف:</strong> ${currentRecord.description.substring(0, 80)}${currentRecord.description.length > 80 ? '...' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            printArea.style.display = 'block';
            
            JsBarcode("#labelBarcode", currentRecord.barcodeContent, {
                format: "CODE128",
                width: 1.5,
                height: 40,
                displayValue: true,
                fontSize: 10,
                textMargin: 2,
                background: "#ffffff",
                lineColor: "#000000"
            });
            
            setTimeout(() => {
                window.print();
                printArea.style.display = 'none';
            }, 500);
        }

        function createPrintArea(isSmall = false) {
            const printArea = document.getElementById('printArea');
            const scale = isSmall ? 0.6 : 1;
            const width = isSmall ? '300px' : '500px';
            
            printArea.innerHTML = `
                <div style="text-align: center; padding: ${isSmall ? '10px' : '20px'}; font-family: Arial; max-width: ${width}; margin: 0 auto; transform: scale(${scale}); transform-origin: center;">
                    <div style="border: 2px solid #f39c12; border-radius: 10px; padding: ${isSmall ? '10px' : '20px'};">
                        <h2 style="color: #2c3e50; margin-bottom: 10px; font-size: ${isSmall ? '1.2rem' : '1.5rem'};">شركة جولن تكس للغزل</h2>
                        <div style="background: #3498db; color: white; padding: 5px; margin-bottom: 15px; border-radius: 5px; font-weight: bold;">
                            رقم تسلسلي: ${currentRecord.serialNumber}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <svg id="printBarcode"></svg>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: ${isSmall ? '0.7rem' : '0.9rem'};">
                            <tr>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">رقم المكنة:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.machineNumber}</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">رقم الرسالة:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.messageNumber}</td>
                            </tr>
                            <tr>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;" colspan="2">الوصف:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;" colspan="2">${currentRecord.description}</td>
                            </tr>
                            <tr>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">التاريخ:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.productionDate}</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">الوردية:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.workShift}</td>
                            </tr>
                            <tr>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">الخليط:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.mixtureType}</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">نوع الخيط:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.threadType}</td>
                            </tr>
                            <tr>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">عدد المبين:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.spindleCount}</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">لون المبين:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">
                                    <span style="display: inline-flex; align-items: center; gap: 5px;">
                                        <span style="width: 15px; height: 15px; background-color: ${currentRecord.spindleColor}; border: 1px solid #ccc; border-radius: 3px;"></span>
                                        ${currentRecord.spindleColorName}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">الوزن القائم:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.totalWeight} كجم</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">الوزن الصافي:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.netWeight} كجم</td>
                            </tr>
                            <tr>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">وزن الصندوق:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.boxWeight} كجم</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">رقم العامل:</td>
                                <td style="padding: ${isSmall ? '4px' : '8px'}; border: 1px solid #ddd;">${currentRecord.workerNumber}</td>
                            </tr>
                        </table>
                        <div style="margin-top: ${isSmall ? '8px' : '15px'}; font-size: ${isSmall ? '0.6rem' : '0.8rem'}; color: #7f8c8d;">
                            تم الإنشاء: ${currentRecord.createdDate} - ${currentRecord.createdTime}
                        </div>
                    </div>
                </div>
            `;
            
            printArea.style.display = 'block';
            
            JsBarcode("#printBarcode", currentRecord.barcodeContent, {
                format: "CODE128",
                width: isSmall ? 2 : 3,
                height: isSmall ? 60 : 80,
                displayValue: true,
                fontSize: isSmall ? 12 : 16,
                textMargin: isSmall ? 5 : 8,
                background: "#ffffff",
                lineColor: "#000000"
            });
            
            setTimeout(() => {
                window.print();
                printArea.style.display = 'none';
            }, 500);
        }

        function downloadBarcodePDF() {
            if (!currentRecord) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // إعدادات الخط
            doc.setFont('helvetica');
            
            // العنوان
            doc.setFontSize(20);
            doc.text('Golden Tex Textile Company', 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.text(`Barcode Production Report - ${currentRecord.serialNumber}`, 105, 30, { align: 'center' });
            
            // البيانات
            let yPos = 50;
            const lineHeight = 8;
            
            const data = [
                ['Serial Number:', currentRecord.serialNumber],
                ['Machine Number:', currentRecord.machineNumber],
                ['Message Number:', currentRecord.messageNumber],
                ['Description:', currentRecord.description],
                ['Production Date:', currentRecord.productionDate],
                ['Shift:', currentRecord.workShift],
                ['Mixture Type:', currentRecord.mixtureType],
                ['Thread Type:', currentRecord.threadType],
                ['Spindle Count:', currentRecord.spindleCount],
                ['Spindle Color:', currentRecord.spindleColorName],
                ['Total Weight:', `${currentRecord.totalWeight} kg`],
                ['Net Weight:', `${currentRecord.netWeight} kg`],
                ['Box Weight:', `${currentRecord.boxWeight} kg`],
                ['Worker Number:', currentRecord.workerNumber],
                ['Barcode Content:', currentRecord.barcodeContent]
            ];
            
            doc.setFontSize(12);
            data.forEach(([label, value]) => {
                doc.text(label, 20, yPos);
                doc.text(value, 80, yPos);
                yPos += lineHeight;
            });
            
            // حفظ الملف
            doc.save(`barcode_${currentRecord.serialNumber}_${new Date().toISOString().split('T')[0]}.pdf`);
            
            showNotification('تم تحميل ملف PDF بنجاح!', 'success');
        }

        function downloadDailyPDF() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = records.filter(record => record.productionDate === today);
            
            if (todayRecords.length === 0) {
                showNotification('لا توجد سجلات لهذا اليوم!', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('Golden Tex - Daily Production Report', 148, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Date: ${today}`, 148, 25, { align: 'center' });
            
            // إعداد الجدول
            let yPos = 40;
            const rowHeight = 6;
            const colWidths = [12, 15, 20, 18, 15, 20, 15, 12, 20, 15, 15, 15, 20];
            const headers = ['Serial', 'Machine', 'Message', 'Date', 'Shift', 'Mixture', 'Thread', 'Spindles', 'Color', 'Total Wt', 'Net Wt', 'Box Wt', 'Worker'];
            
            // رسم الرأس
            doc.setFontSize(7);
            let xPos = 10;
            headers.forEach((header, i) => {
                doc.rect(xPos, yPos - 4, colWidths[i], rowHeight);
                doc.text(header, xPos + 1, yPos);
                xPos += colWidths[i];
            });
            
            yPos += rowHeight;
            
            // رسم البيانات
            todayRecords.forEach(record => {
                xPos = 10;
                const rowData = [
                    record.serialNumber,
                    record.machineNumber,
                    record.messageNumber,
                    record.productionDate,
                    record.workShift.substring(0, 4),
                    record.mixtureType.substring(0, 15),
                    record.threadType.substring(0, 10),
                    record.spindleCount.toString(),
                    record.spindleColorName.substring(0, 10),
                    record.totalWeight.toString(),
                    record.netWeight.toString(),
                    record.boxWeight.toString(),
                    record.workerNumber
                ];
                
                rowData.forEach((data, i) => {
                    doc.rect(xPos, yPos - 4, colWidths[i], rowHeight);
                    doc.text(data, xPos + 1, yPos);
                    xPos += colWidths[i];
                });
                
                yPos += rowHeight;
                
                if (yPos > 180) {
                    doc.addPage();
                    yPos = 20;
                }
            });
            
            // الإحصائيات
            yPos += 10;
            const totalSpindles = todayRecords.reduce((sum, record) => sum + record.spindleCount, 0);
            const totalNetWeight = todayRecords.reduce((sum, record) => sum + record.netWeight, 0);
            const uniqueMachines = new Set(todayRecords.map(record => record.machineNumber)).size;
            
            doc.setFontSize(12);
            doc.text('Daily Summary:', 10, yPos);
            yPos += 8;
            doc.setFontSize(10);
            doc.text(`Total Records: ${todayRecords.length}`, 10, yPos);
            yPos += 6;
            doc.text(`Machines Used: ${uniqueMachines}`, 10, yPos);
            yPos += 6;
            doc.text(`Total Spindles: ${totalSpindles}`, 10, yPos);
            yPos += 6;
            doc.text(`Total Net Weight: ${totalNetWeight.toFixed(2)} kg`, 10, yPos);
            
            doc.save(`daily_report_${today}.pdf`);
            showNotification('تم تحميل التقرير اليومي بنجاح!', 'success');
        }

        function clearForm() {
            document.getElementById('barcodeForm').reset();
            document.getElementById('productionDate').value = new Date().toISOString().split('T')[0];
            document.querySelectorAll('.shift-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('workShift').value = '';
            document.getElementById('spindleColor').value = '#ffffff';
            document.getElementById('spindleColorName').value = 'أبيض';
            
            // إزالة تأثيرات الملء التلقائي
            document.querySelectorAll('.weight-auto-fill').forEach(el => el.classList.remove('weight-auto-fill'));
            
            document.getElementById('previewSection').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-barcode"></i>
                    <div>قم بملء البيانات لمعاينة الباركود</div>
                </div>
            `;
            currentRecord = null;
        }

        function exportData() {
            if (records.length === 0) {
                showNotification('لا توجد بيانات للتصدير!', 'warning');
                return;
            }

            const csvContent = [
                ['الرقم التسلسلي', 'رقم المكنة', 'رقم الرسالة', 'محتوى الباركود', 'الوصف', 'تاريخ الإنتاج', 'الوردية', 'الخليط', 'نوع الخيط', 'عدد المبين', 'لون المبين', 'الوزن القائم', 'الوزن الصافي', 'وزن الصندوق', 'رقم العامل', 'تاريخ الإنشاء', 'وقت الإنشاء'],
                ...records.map(record => [
                    record.serialNumber,
                    record.machineNumber,
                    record.messageNumber,
                    record.barcodeContent,
                    record.description,
                    record.productionDate,
                    record.workShift,
                    record.mixtureType,
                    record.threadType,
                    record.spindleCount,
                    record.spindleColorName,
                    record.totalWeight,
                    record.netWeight,
                    record.boxWeight,
                    record.workerNumber,
                    record.createdDate,
                    record.createdTime
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `golden_tex_production_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification('تم تصدير البيانات بنجاح!', 'success');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = 
                type === 'success' ? 'linear-gradient(135deg, #27ae60, #219a52)' : 
                type === 'warning' ? 'linear-gradient(135deg, #f39c12, #e67e22)' : 
                'linear-gradient(135deg, #e74c3c, #c0392b)';
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // إضافة مستمعي الأحداث
        document.getElementById('searchInput').addEventListener('input', updateTable);
        document.getElementById('filterMachine').addEventListener('change', updateTable);
        document.getElementById('filterMixture').addEventListener('change', updateTable);
        document.getElementById('filterShift').addEventListener('change', updateTable);
        document.getElementById('filterDate').addEventListener('change', updateTable);

        // معاينة فورية عند تغيير حقول الإدخال
        [
            'productionDate','machineNumber','messageNumber','barcodeContent','description',
            'mixtureType','threadType','spindleCount','spindleColor','spindleColorName',
            'totalWeight','netWeight','boxWeight','workerNumber'
        ].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', updateLivePreview);
                el.addEventListener('change', updateLivePreview);
            }
        });

        // تحميل البيانات عند فتح الصفحة
        updateTable();
        updateMachineFilter();
        updateDailySummary();
        updateScaleStatus();
        updateLivePreview();

        // حفظ البيانات تلقائياً
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('goldenTexBarcodeRecords', JSON.stringify(records));
            localStorage.setItem('goldenTexSerialNumber', serialNumber);
        });

        // إضافة أرقام تلقائية للرسائل
        let messageCounter = parseInt(localStorage.getItem('goldenTexMessageCounter')) || 1;

        document.getElementById('messageNumber').addEventListener('focus', function() {
            if (!this.value) {
                this.value = `MSG${String(messageCounter).padStart(4, '0')}`;
            }
        });

        document.getElementById('barcodeForm').addEventListener('submit', function() {
            messageCounter++;
            localStorage.setItem('goldenTexMessageCounter', messageCounter);
        });
    </script>
</body>
</html>

